<!-- 관련 포스트 설정 (디버그 포함) -->
{% assign DEBUG = true %}   {# 디버그 끄려면 false로 바꿔 #}
{% assign TOTAL_SIZE = 3 %}
{% assign TAG_SCORE = 10 %}
{% assign CATEGORY_SCORE = 1 %}
{% assign SEPARATOR = ':' %}

<!-- 무시할 공통 태그/카테고리 -->
{% assign IGNORE_TAGS = "Kotlin" | split: "," %}
{% assign IGNORE_CATEGORIES = "백준" | split: "," %}

{%- comment -%}
  안전한 후보 수집 로직:
  - site.categories[category] 혹은 site.tags[tag] 가 비어있을 수 있으므로 체크
  - concat 사용 (배열 병합)
  - 자기 자신 제외는 후보 수집 단계에서 미리 처리
{%- endcomment -%}

{% assign match_posts = '' | split: '' %}

<!-- 후보군 생성: 카테고리 (필터링 적용) -->
{% for category in page.categories %}
  {% unless IGNORE_CATEGORIES contains category %}
    {% if site.categories[category] %}
      {% for p in site.categories[category] %}
        {% unless p.url == page.url %}
          {% assign match_posts = match_posts | push: p %}
        {% endunless %}
      {% endfor %}
    {% endif %}
  {% endunless %}
{% endfor %}

<!-- 후보군 생성: 태그 (필터링 적용) -->
{% for tag in page.tags %}
  {% unless IGNORE_TAGS contains tag %}
    {% if site.tags[tag] %}
      {% for p in site.tags[tag] %}
        {% unless p.url == page.url %}
          {% assign match_posts = match_posts | push: p %}
        {% endunless %}
      {% endfor %}
    {% endif %}
  {% endunless %}
{% endfor %}

<!-- 중복 제거 & 정렬 (URL 기준 안정적) -->
{% assign match_posts = match_posts | uniq %}
{% assign match_posts = match_posts | sort: "date" | reverse %}

<!-- 디버그 출력 (간단 정보) -->
{% if DEBUG %}
  <div style="border:2px dashed #e07; padding:8px; margin:8px 0; font-family:monospace;">
    <strong>Related Debug Info</strong><br/>
    page.url: <code>{{ page.url }}</code><br/>
    page.tags: <code>{{ page.tags | join: ', ' }}</code><br/>
    page.categories: <code>{{ page.categories | join: ', ' }}</code><br/>
    IGNORE_TAGS: <code>{{ IGNORE_TAGS | join: ', ' }}</code><br/>
    IGNORE_CATEGORIES: <code>{{ IGNORE_CATEGORIES | join: ', ' }}</code><br/>
    candidate count (match_posts.size): <strong>{{ match_posts | size }}</strong><br/>
    candidate titles (first 10):<br/>
    <ol style="margin:4px 0 0 18px; padding:0;">
      {% for p in match_posts limit:10 %}
        <li><code>{{ p.title }}</code> — <small>{{ p.url }}</small></li>
      {% endfor %}
    </ol>
  </div>
{% endif %}

{% assign score_list = '' | split: '' %}

<!-- 점수 계산 -->
{% for post in match_posts %}
  {% comment %} post 가 실제 포스트 객체인지 안전 검사 {% endcomment %}
  {% if post == nil %}
    {% continue %}
  {% endif %}

  {% assign score = 0 %}

  <!-- 태그 점수 (IGNORE_TAGS 무시) -->
  {% if post.tags %}
    {% for t in post.tags %}
      {% if page.tags contains t and not IGNORE_TAGS contains t %}
        {% assign score = score | plus: TAG_SCORE %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <!-- 카테고리 점수 (IGNORE_CATEGORIES 무시) -->
  {% if post.categories %}
    {% for c in post.categories %}
      {% if page.categories contains c and not IGNORE_CATEGORIES contains c %}
        {% assign score = score | plus: CATEGORY_SCORE %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if score > 0 %}
    {% capture score_item %}{{ score }}{{ SEPARATOR }}{{ post.url }}{% endcapture %}
    {% assign score_list = score_list | push: score_item %}
  {% endif %}
{% endfor %}

{% if DEBUG %}
  <div style="border:2px dashed #0a7; padding:8px; margin:8px 0; font-family:monospace;">
    score_list.size: <strong>{{ score_list | size }}</strong><br/>
    score_list (top 10):<br/>
    <ol style="margin:4px 0 0 18px; padding:0;">
      {% assign tmp = score_list | sort | reverse %}
      {% for item in tmp limit:10 %}
        {% assign parts = item | split: SEPARATOR %}
        <li><code>score={{ parts[0] }}</code> — <code>{{ parts[1] }}</code></li>
      {% endfor %}
    </ol>
  </div>
{% endif %}

<!-- 상위 TOTAL_SIZE 개 선택 -->
{% assign relate_posts = '' | split: '' %}
{% if score_list.size > 0 %}
  {% assign sorted_scores = score_list | sort | reverse %}
  {% for entry in sorted_scores limit: TOTAL_SIZE %}
    {% assign url = entry | split: SEPARATOR | last %}
    {% assign p = site.posts | where: "url", url | first %}
    {% if p %}
      {% assign relate_posts = relate_posts | push: p %}
    {% endif %}
  {% endfor %}
{% endif %}

<!-- HTML 렌더링 (원본 스타일 유지) -->
{% if relate_posts.size > 0 %}
  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">
      {{- site.data.locales[include.lang].post.relate_posts -}}
    </h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      {% for post in relate_posts %}
        <article class="col">
          <a href="{{ post.url | relative_url }}" class="post-preview card h-100">
            <div class="card-body">
              {% include datetime.html date=post.date lang=include.lang %}
              <h4 class="pt-0 my-2">{{ post.title }}</h4>
              <div class="text-muted">
                <p>{% include post-summary.html %}</p>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </nav>
  </aside>
{% else %}
  {% if DEBUG %}
    <div style="color:#b00; font-family:monospace; margin:8px 0;">
      (디버그) 관련 포스트가 없습니다. 위 candidate list와 score_list를 확인하세요.
    </div>
  {% endif %}
{% endif %}
