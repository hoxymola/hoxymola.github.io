<!-- 관련 포스트 설정 -->
{% assign TOTAL_SIZE = 3 %}
{% assign TAG_SCORE = 10 %}
{% assign CATEGORY_SCORE = 1 %}
{% assign SEPARATOR = ':' %}

<!-- 무시할 공통 태그/카테고리 -->
{% assign IGNORE_TAGS = "Kotlin" | split: "," %}
{% assign IGNORE_CATEGORIES = "백준" | split: "," %}

{% assign match_posts = '' | split: '' %}

<!-- 후보군 생성: 카테고리 (필터링 적용) -->
{% assign filtered_categories = '' | split: '' %}
{% for category in page.categories %}
  {% unless IGNORE_CATEGORIES contains category %}
    {% assign filtered_categories = filtered_categories | push: category %}
  {% endunless %}
{% endfor %}

{% for category in filtered_categories %}
  {% for post in site.categories[category] %}
    {% unless post.url == page.url %}
      {% assign match_posts = match_posts | push: post %}
    {% endunless %}
  {% endfor %}
{% endfor %}

<!-- 후보군 생성: 태그 (필터링 적용) -->
{% assign filtered_tags = '' | split: '' %}
{% for tag in page.tags %}
  {% unless IGNORE_TAGS contains tag %}
    {% assign filtered_tags = filtered_tags | push: tag %}
  {% endunless %}
{% endfor %}

{% for tag in filtered_tags %}
  {% for post in site.tags[tag] %}
    {% unless post.url == page.url %}
      {% assign match_posts = match_posts | push: post %}
    {% endunless %}
  {% endfor %}
{% endfor %}

<!-- 중복 제거 -->
{% assign match_posts = match_posts | uniq %}

{% assign score_list = '' | split: '' %}

<!-- 점수 계산 -->
{% for post in match_posts %}
  {% assign score = 0 %}

  <!-- 태그 점수 -->
  {% for tag in post.tags %}
    {% if page.tags contains tag and not IGNORE_TAGS contains tag %}
      {% assign score = score | plus: TAG_SCORE %}
    {% endif %}
  {% endfor %}

  <!-- 카테고리 점수 -->
  {% for category in post.categories %}
    {% if page.categories contains category and not IGNORE_CATEGORIES contains category %}
      {% assign score = score | plus: CATEGORY_SCORE %}
    {% endif %}
  {% endfor %}

  {% if score > 0 %}
    {% capture score_item %}{{ score }}{{ SEPARATOR }}{{ post.url }}{% endcapture %}
    {% assign score_list = score_list | push: score_item %}
  {% endif %}
{% endfor %}

<!-- 상위 TOTAL_SIZE 개 선택 -->
{% assign index_list = '' | split: '' %}
{% if score_list.size > 0 %}
  {% assign score_list = score_list | sort | reverse %}
  {% for entry in score_list limit: TOTAL_SIZE %}
    {% assign url = entry | split: SEPARATOR | last %}
    {% assign index_list = index_list | push: url %}
  {% endfor %}
{% endif %}

{% assign relate_posts = '' | split: '' %}
{% for url in index_list %}
  {% assign post = site.posts | where: "url", url | first %}
  {% assign relate_posts = relate_posts | push: post %}
{% endfor %}

<!-- HTML 렌더링 -->
{% if relate_posts.size > 0 %}
  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">
      {{- site.data.locales[include.lang].post.relate_posts -}}
    </h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      {% for post in relate_posts %}
        <article class="col">
          <a href="{{ post.url | relative_url }}" class="post-preview card h-100">
            <div class="card-body">
              {% include datetime.html date=post.date lang=include.lang %}
              <h4 class="pt-0 my-2">{{ post.title }}</h4>
              <div class="text-muted">
                <p>{% include post-summary.html %}</p>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </nav>
  </aside>
{% endif %}
